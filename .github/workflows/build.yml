name: Build ISO

on:
  push:
    branches: [main, master]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches: [main, master]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'standard'
        type: choice
        options:
          - standard
          - force-clean

env:
  ISO_NAME: ai-rescue-linux

jobs:
  build:
    name: Build AI Rescue Linux ISO
    runs-on: ubuntu-24.04
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          echo "==> Freeing up disk space..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force || true
          df -h

      - name: Install dependencies
        run: |
          echo "==> Installing build dependencies..."
          sudo apt-get update
          sudo apt-get install -y \
            live-build \
            debootstrap \
            xorriso \
            isolinux \
            syslinux-efi \
            grub-pc-bin \
            grub-efi-amd64-bin \
            mtools \
            squashfs-tools \
            syslinux-utils \
            dosfstools \
            parted

      - name: Cache debootstrap packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-${{ hashFiles('config/package-lists/*.list.chroot') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      - name: Validate configuration
        run: |
          echo "==> Validating build configuration..."

          # Check required files exist
          for file in build.sh config/binary config/bootstrap config/chroot; do
            if [[ ! -f "$file" ]]; then
              echo "ERROR: Required file missing: $file"
              exit 1
            fi
          done

          # Check hooks are executable
          for hook in config/hooks/live/*.hook.*; do
            if [[ -f "$hook" && ! -x "$hook" ]]; then
              echo "WARNING: Making hook executable: $hook"
              chmod +x "$hook"
            fi
          done

          # Check package lists exist
          if [[ ! -d "config/package-lists" ]] || [[ -z "$(ls config/package-lists/*.list.chroot 2>/dev/null)" ]]; then
            echo "ERROR: No package lists found in config/package-lists/"
            exit 1
          fi

          echo "==> Configuration validation passed"

      - name: Build ISO
        run: |
          echo "==> Starting ISO build..."

          # Set build flags based on input
          BUILD_FLAGS="--skip-config"
          if [[ "${{ github.event.inputs.build_type }}" == "force-clean" ]]; then
            BUILD_FLAGS="--force --skip-config"
          fi

          # Run the build
          sudo ./build.sh $BUILD_FLAGS

          # Verify ISO was created
          if [[ -f "${ISO_NAME}.iso" ]]; then
            echo "==> ISO built successfully!"
            ls -lh "${ISO_NAME}.iso"
          else
            echo "ERROR: ISO file not found after build"
            exit 1
          fi

      - name: Generate checksums
        run: |
          echo "==> Generating checksums..."
          sha256sum ${ISO_NAME}.iso > ${ISO_NAME}.iso.sha256
          md5sum ${ISO_NAME}.iso > ${ISO_NAME}.iso.md5
          cat ${ISO_NAME}.iso.sha256

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ISO_NAME }}-${{ github.sha }}
          path: |
            ${{ env.ISO_NAME }}.iso
            ${{ env.ISO_NAME }}.iso.sha256
            ${{ env.ISO_NAME }}.iso.md5
          retention-days: 7
          compression-level: 0  # ISO is already compressed

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ github.sha }}
          path: build.log
          retention-days: 7

  build-info:
    name: Build Information
    runs-on: ubuntu-latest
    needs: build
    if: success()

    steps:
      - name: Build summary
        run: |
          echo "## Build Successful! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- ISO image available for 7 days" >> $GITHUB_STEP_SUMMARY
          echo "- Download from the Actions artifacts section" >> $GITHUB_STEP_SUMMARY

#!/bin/bash
# Password Reset Helper

echo "╔══════════════════════════════════════════════════════════════╗"
echo "║              Password Reset Assistant                        ║"
echo "╚══════════════════════════════════════════════════════════════╝"
echo ""
echo "Options:"
echo ""
echo "  1. Reset Linux user password (via chroot)"
echo "  2. Reset/Remove Windows password (chntpw)"
echo "  3. View Linux shadow file entries"
echo ""
read -rp "Select option [1-3]: " opt

case $opt in
    1)
        echo ""
        echo "First, mount the Linux root partition."
        ai-mount
        read -rp "Enter mount point (e.g., /mnt/sda1): " mnt

        if [ ! -f "$mnt/etc/passwd" ]; then
            echo "Not a valid Linux root. /etc/passwd not found."
            exit 1
        fi

        echo ""
        echo "Users with login shells:"
        grep -E "/bin/(bash|sh|zsh)" "$mnt/etc/passwd" | cut -d: -f1
        echo ""
        read -rp "Username to reset: " username

        # Chroot and reset password
        mount --bind /dev "$mnt/dev"
        mount --bind /proc "$mnt/proc"
        mount --bind /sys "$mnt/sys"

        echo "Enter new password for $username:"
        chroot "$mnt" passwd "$username"

        umount "$mnt/dev" "$mnt/proc" "$mnt/sys"
        echo "Password reset complete!"
        ;;
    2)
        echo ""
        echo "Windows password reset using chntpw"
        echo ""
        echo "First, mount the Windows partition."
        ai-mount
        read -rp "Enter mount point: " mnt

        SAM_PATH="$mnt/Windows/System32/config/SAM"
        if [ ! -f "$SAM_PATH" ]; then
            # Try lowercase
            SAM_PATH="$mnt/windows/system32/config/SAM"
        fi

        if [ ! -f "$SAM_PATH" ]; then
            echo "SAM file not found. Is this a Windows partition?"
            exit 1
        fi

        echo "Launching chntpw..."
        cd "$(dirname "$SAM_PATH")" || exit 1
        chntpw -i SAM
        ;;
    3)
        echo ""
        read -rp "Path to mounted Linux root: " mnt
        if [ -f "$mnt/etc/shadow" ]; then
            echo ""
            echo "Shadow entries (password hashes hidden):"
            cut -d: -f1,3,4,5 "$mnt/etc/shadow"
        else
            echo "Shadow file not found at $mnt/etc/shadow"
        fi
        ;;
esac
